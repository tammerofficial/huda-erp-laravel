name: Deploy to cPanel (via SSH)

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Parse cPanel connection secret
        id: parse
        shell: bash
        run: |
          set -e
          # Write environment secret to a temp file
          cat > .cpanel_secret <<'EOF'
          ${{ secrets.WORKSHOP_HOSTINGER_CP }}
          EOF
          # Normalize CRLF -> LF
          sed -i 's/\r$//' .cpanel_secret
          # Extract fields
          getv () { grep -E "^[[:space:]]*$1[[:space:]]*=" .cpanel_secret | head -1 | sed -E "s/^[[:space:]]*$1[[:space:]]*=[[:space:]]*//" ; }
          HOST="$(getv CPANEL_HOST)"
          USER="$(getv CPANEL_USER)"
          PASS="$(getv CPANEL_PASSWORD)"
          PORT="$(getv CPANEL_PORT)"
          REPO_PATH="$(getv CPANEL_REPO_PATH)"
          # Defaults
          [ -z "$PORT" ] && PORT="22"
          # Basic validation
          echo "Parsed:"
          echo "  HOST=${HOST:-<empty>}"
          echo "  USER=${USER:-<empty>}"
          echo "  PORT=${PORT:-<empty>}"
          echo "  REPO_PATH=${REPO_PATH:-<empty>}"
          if [ -z "$HOST" ] || [ -z "$USER" ] || [ -z "$PASS" ] || [ -z "$REPO_PATH" ]; then
            echo "::error::Missing one or more required keys in WORKSHOP_HOSTINGER_CP. Expecting lines: CPANEL_HOST=..., CPANEL_USER=..., CPANEL_PASSWORD=..., CPANEL_REPO_PATH=..., optional CPANEL_PORT=22"
            exit 1
          fi
          echo "host=$HOST" >> "$GITHUB_OUTPUT"
          echo "user=$USER" >> "$GITHUB_OUTPUT"
          echo "password=$PASS" >> "$GITHUB_OUTPUT"
          echo "port=$PORT" >> "$GITHUB_OUTPUT"
          echo "repo_path=$REPO_PATH" >> "$GITHUB_OUTPUT"

      - name: SSH to cPanel and pull latest (triggers .cpanel.yml deployment)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.parse.outputs.host }}
          username: ${{ steps.parse.outputs.user }}
          password: ${{ steps.parse.outputs.password }}
          port: ${{ steps.parse.outputs.port }}
          script_stop: true
          script: |
            set -e
            echo "Deploying ref $GITHUB_REF"
            REPO_PATH='${{ steps.parse.outputs.repo_path }}'
            echo "Using REPO_PATH=$REPO_PATH"
            cd "$REPO_PATH"
            git fetch --all
            git checkout main
            # Handle local changes that conflict with incoming changes
            # Stash local changes to .htaccess and other files if they exist
            if [ -n "$(git status --porcelain public/.htaccess 2>/dev/null)" ]; then
              echo "Stashing local changes to public/.htaccess"
              git stash push -m "Stash local .htaccess before pull" public/.htaccess 2>/dev/null || true
            fi
            # Reset any uncommitted changes to tracked files
            git reset --hard HEAD 2>/dev/null || true
            # Now pull the latest changes
            git pull origin main || {
              echo "Pull failed, trying with reset..."
              git reset --hard origin/main
            }
            echo "Pulled latest changes. cPanel post-receive hook should run .cpanel.yml automatically."


